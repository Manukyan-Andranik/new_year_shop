{% extends "admin/admin_base.html" %}

{% block title %}ðŸ“¦ Orders - Admin Dashboard{% endblock %}

{% block content %}
<div class="panel-body">
  <main style="padding:18px">
    <h1>Customer Orders</h1>

    <div id="ordersList" style="display:grid;gap:1.25rem"></div>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function(){
    const BASE_PREFIX = "{{ BASE_PREFIX if BASE_PREFIX is defined else '' }}";

    async function loadOrders() {
      try {
        const res = await fetch(`${BASE_PREFIX}/api/admin/orders`, { credentials:'include' })
        const orders = await res.json()
        displayOrders(Array.isArray(orders) ? orders : (orders.orders || []))
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = `<p class="small-muted">Failed to load orders.</p>`
      }
    }

    function displayOrders(orders) {
      const container = document.getElementById('ordersList');

      if (!orders || orders.length === 0) {
        container.innerHTML = `<p class="small-muted">No orders found.</p>`;
        return;
      }

      container.innerHTML = orders.map(order => {
        const itemsHtml = (order.items || []).map(item => `
          <div class="order-item" style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0;border-bottom:1px solid #eee">
            <div style="display:flex;align-items:center;gap:10px">
              <img class="product-image" src="${BASE_PREFIX}${item.image || ''}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #ddd">
              <span style="font-weight:500">${item.name} x${item.qty}</span>
            </div>
            <span style="font-weight:500;color:var(--danger)">\$${((item.price||0) * (item.qty||1)).toFixed(2)}</span>
          </div>
        `).join('')

        const total = (order.items || []).reduce((sum, item) => sum + ((item.price||0) * (item.qty||1)), 0).toFixed(2)

        return `
          <div class="order-card" style="background:white;border-radius:12px;padding:1.25rem;box-shadow:var(--shadow)">
            <div class="order-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid #87CEEB">
              <div><span style="font-weight:600;color:var(--accent)">Order #${order.id}</span> - ${new Date(order.created_at).toLocaleDateString()}</div>
              <select class="status-select" onchange="updateOrderStatus(${order.id}, this.value)">
                <option value="new" ${order.status === 'new' ? 'selected' : ''}>New</option>
                <option value="processed" ${order.status === 'processed' ? 'selected' : ''}>Processed</option>
                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
              </select>
            </div>

            <div class="order-details" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
              <div>
                <strong>Customer:</strong> ${order.customer_name || 'â€”'}<br>
                <strong>Phone:</strong> ${order.phone || 'â€”'}<br>
                <strong>Email:</strong> ${order.email || 'â€”'}
              </div>
              <div>
                <strong>Status:</strong> <span style="padding:0.3rem 0.8rem;border-radius:15px;font-weight:600">${(order.status||'').toUpperCase()}</span><br>
                ${order.comment ? `<strong>Comment:</strong> ${order.comment}` : ''}
              </div>
            </div>

            <div class="order-items">
              <strong>Items:</strong>
              ${itemsHtml}
              <div class="order-total" style="display:flex;justify-content:space-between;font-weight:600;border-top:2px solid var(--gold);padding-top:10px;margin-top:10px">
                <span>Total:</span>
                <span>$${total}</span>
              </div>
            </div>
          </div>
        `
      }).join('');
    }

    window.updateOrderStatus = async function(orderId, newStatus) {
      try {
        const response = await fetch(`${BASE_PREFIX}/api/admin/orders/${orderId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
          loadOrders();
        } else {
          alert('Error updating order status');
        }
      } catch (error) {
        alert('Failed to update order status');
      }
    }

    document.addEventListener('DOMContentLoaded', loadOrders);
  })();
</script>
{% endblock %}
